//
// Created by gregorian-rayne on 12/28/25.
//

#ifndef BHA_MSVC_PARSER_HPP
#define BHA_MSVC_PARSER_HPP

/**
 * @file msvc_parser.hpp
 * @brief MSVC /Bt+ and /d1reportTime parser.
 *
 * Parses the timing output generated by MSVC's /Bt+ flag (build timing)
 * and /d1reportTime (detailed front-end timing).
 */

#include "bha/parsers/parser.hpp"

namespace bha::parsers {

    /**
     * Parser for MSVC timing output.
     *
     * MSVC provides timing information through:
     * - /Bt+ : Shows c1xx.dll and c2.dll timing (front-end and back-end)
     * - /d1reportTime : Detailed front-end timing breakdown
     *
     * Example /Bt+ output:
     *   time(C:\path\file.cpp)=0.852s
     *   time(c1xx.dll)=0.612s < 0.589s (Frontend), 0.023s (Template instantiation) >
     *   time(c2.dll)=0.240s
     */
    class MSVCTraceParser : public ITraceParser {
    public:
        [[nodiscard]] std::string_view name() const noexcept override {
            return "MSVC";
        }

        [[nodiscard]] CompilerType compiler_type() const noexcept override {
            return CompilerType::MSVC;
        }

        [[nodiscard]] std::vector<std::string> supported_extensions() const override {
            return {".txt", ".log", ".btlog"};
        }

        [[nodiscard]] bool can_parse(const fs::path& path) const override;

        [[nodiscard]] bool can_parse_content(std::string_view content) const override;

        [[nodiscard]] Result<CompilationUnit, Error> parse_file(
            const fs::path& path
        ) const override;

        [[nodiscard]] Result<CompilationUnit, Error> parse_content(
            std::string_view content,
            const fs::path& source_hint
        ) const override;
    };

    /**
     * Registers the MSVC parser with the global registry.
     */
    void register_msvc_parser();

}  // namespace bha::parsers

#endif //BHA_MSVC_PARSER_HPP